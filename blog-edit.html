<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Blog Post</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body style="background:#020817;">
    <div class="container mt-5" style="max-width:600px;">
        <h2 class="text-white mb-4">Create Blog Post</h2>
        <form id="editBlogForm">
            <div class="form-group">
                <input type="text" class="form-control" id="blogHeader" required placeholder="Header">
            </div>
            <div class="form-group">
                <input type="text" class="form-control" id="blogTitle" required placeholder="Title">
            </div>
            <div class="form-group">
                <input type="text" class="form-control" id="blogDesc" required placeholder="Description">
            </div>
            <div class="form-group">
                <input type="text" class="form-control" id="blogImage" required placeholder="Image URL">
            </div>
            <div class="form-group">
                <textarea class="form-control" id="blogText" rows="5" required placeholder="Text"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save Blog</button>
            <a href="index.html" class="btn btn-secondary ml-2">Cancel</a>
        </form>
    </div>
    <script>
        function isAdmin() {
            return localStorage.getItem('isAdmin') === 'true';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                // Fetch blog data
                const res = await fetch(`/.netlify/functions/get-blog?id=${id}`);
                if (res.ok) {
                    const blog = await res.json();
                    document.getElementById('blogHeader').value = blog.header;
                    document.getElementById('blogTitle').value = blog.title;
                    document.getElementById('blogDesc').value = blog.description;
                    document.getElementById('blogImage').value = blog.image;
                    document.getElementById('blogText').value = blog.text;
                }
            }

            // Edit form submission
            const form = document.getElementById('editBlogForm');
            if (form) {
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    if (!localStorage.getItem('isAdmin') === 'true') {
                        alert('Only admin can edit posts.');
                        return false;
                    }
                    const blog = {
                        id, // include id for update
                        header: document.getElementById('blogHeader').value,
                        title: document.getElementById('blogTitle').value,
                        description: document.getElementById('blogDesc').value,
                        image: document.getElementById('blogImage').value,
                        text: document.getElementById('blogText').value
                    };
                    const res = await fetch('/.netlify/functions/create-blog', {
                        method: id ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(blog)
                    });
                    let data;
                    try {
                        data = await res.json();
                    } catch (e) {
                        alert('Server error: Could not parse response.');
                        return;
                    }
                    if (data.success) {
                        alert('Blog post saved!');
                        window.location.href = 'index.html#blogs';
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                };
            }
        });
    </script>
</body>
</html>